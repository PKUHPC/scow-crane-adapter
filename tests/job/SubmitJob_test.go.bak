package main

import (
	"context"
	"fmt"
	"testing"

	"github.com/stretchr/testify/assert"
	"google.golang.org/grpc"

	pb "scow-crane-adapter/gen/go"
)

func TestSubmitJob(t *testing.T) {

	// Set up a connection to the server
	conn, err := grpc.Dial("localhost:8972", grpc.WithInsecure(), grpc.WithDefaultCallOptions(grpc.MaxCallRecvMsgSize(1024*1024*1024)))
	if err != nil {
		t.Fatalf("did not connect: %v", err)
	}
	defer conn.Close()
	client := pb.NewJobServiceClient(conn)
	memory := uint64(2048)
	lt := uint32(3000)
	qos := "UNLIMITED"
	extraOptions := []string{
		"app",
		"web",
		"ccrepo.pku.edu.cn/dockerhub/library/scipy-notebook:x86_64-notebook-7.2.1",
		"[]",
		"[]",
		"/data/crane-ai/module",
		"/data/crane-ai/mount/test1,/data/crane-ai/mount/test2",
		"",
		"/data/crane-ai/mount/test3,/data/crane-ai/mount/test4",
	}

	req := &pb.SubmitJobRequest{
		UserId:           "test",
		JobName:          "testApp",
		Account:          "test",
		Partition:        "CPU",
		Qos:              &qos,
		CoreCount:        1,
		MemoryMb:         &memory,
		WorkingDirectory: "/root/",
		Script:           "/root/app-entry.sh",
		ExtraOptions:     extraOptions,
		TimeLimitMinutes: &lt,
	}
	res, err := client.SubmitJob(context.Background(), req)
	fmt.Println(err)
	if err != nil {
		t.Fatalf("create dev host failed: %v", err)
	}
	fmt.Println(res)

	// assert.Empty(t, err)
	assert.IsType(t, uint32(1), res.JobId)
}

func TestSubmitApp(t *testing.T) {

	// Set up a connection to the server
	conn, err := grpc.Dial("localhost:8972", grpc.WithInsecure(), grpc.WithDefaultCallOptions(grpc.MaxCallRecvMsgSize(1024*1024*1024)))
	if err != nil {
		t.Fatalf("did not connect: %v", err)
	}
	defer conn.Close()
	client := pb.NewJobServiceClient(conn)
	memory := uint64(2048)
	lt := uint32(3000)
	qos := "UNLIMITED"
	extraOptions := []string{
		"app",
		"web",
		"ccrepo.pku.edu.cn/dockerhub/library/scipy-notebook:x86_64-notebook-7.2.1",
		"[]",
		"[]",
		"/data/home/test/crane-ai/module",
		"/data/home/test/crane-ai/mount/test1,/data/home/test/crane-ai/mount/test2",
		"",
		"/data/home/test/crane-ai/mount/test3,/data/home/test/crane-ai/mount/test4",
	}

	req := &pb.SubmitJobRequest{
		UserId:           "test",
		JobName:          "testApp",
		Account:          "test",
		Partition:        "compute",
		Qos:              &qos,
		CoreCount:        1,
		MemoryMb:         &memory,
		WorkingDirectory: "/data/home/test",
		Script:           "/data/home/test/app-entry.sh",
		ExtraOptions:     extraOptions,
		TimeLimitMinutes: &lt,
	}
	res, err := client.SubmitJob(context.Background(), req)
	fmt.Println(err)
	if err != nil {
		t.Fatalf("create dev host failed: %v", err)
	}
	fmt.Println(res)
}

func TestSubmitInference(t *testing.T) {

	// Set up a connection to the server
	conn, err := grpc.Dial("localhost:8972", grpc.WithInsecure(), grpc.WithDefaultCallOptions(grpc.MaxCallRecvMsgSize(1024*1024*1024)))
	if err != nil {
		t.Fatalf("did not connect: %v", err)
	}
	defer conn.Close()
	client := pb.NewJobServiceClient(conn)
	memory := uint64(2048)
	qos := "UNLIMITED"
	extraOptions := []string{"docker.io/library/nginx:1.27", "/data/home/test/module/",
		"", "", ""}
	req := &pb.SubmitInferJobRequest{
		UserId:               "test",
		JobName:              "testInf",
		Account:              "test",
		Partition:            "compute",
		Qos:                  &qos,
		CoreCount:            1,
		MemoryMb:             &memory,
		WorkingDirectory:     "/data/home/test/",
		NodeCount:            1,
		ExtraOptions:         extraOptions,
		Script:               "/data/home/test/entry.sh",
		ContainerServicePort: 80,
	}
	res, err := client.SubmitInferJob(context.Background(), req)
	fmt.Println(err)
	if err != nil {
		t.Fatalf("create inference failed: %v", err)
	}
	fmt.Println(res)
}

func TestSubmitDevHost1(t *testing.T) {

	// Set up a connection to the server
	conn, err := grpc.Dial("localhost:8972", grpc.WithInsecure(), grpc.WithDefaultCallOptions(grpc.MaxCallRecvMsgSize(1024*1024*1024)))
	if err != nil {
		t.Fatalf("did not connect: %v", err)
	}
	defer conn.Close()
	client := pb.NewJobServiceClient(conn)
	memory := uint64(2048)
	lt := uint32(3000)
	req := &pb.CreateDevHostRequest{
		UserId:           "test",
		JobName:          "test123",
		Account:          "test",
		Partition:        "compute",
		Qos:              "UNLIMITED",
		CoreCount:        1,
		MemoryMb:         &memory,
		WorkingDirectory: "/data/home/test/",
		VscodeInfo: &pb.CreateDevHostRequest_VscodeInfo{
			VscodeBinPath: "/root/devhost/code-server-4.96.2-linux-amd64/bin/code-server",
		},
		JupyterLabInfo: &pb.CreateDevHostRequest_JupyterLabInfo{
			ProxyBasePath: "/api/proxy/jyb-k8s/absolute",
		},
		Mounts:           []string{},
		Image:            "ccrepo.pku.edu.cn/dockerhub/library/pytorch-ddp-test:v1",
		TimeLimitMinutes: &lt,
	}
	res, err := client.CreateDevHost(context.Background(), req)
	fmt.Println(err)
	if err != nil {
		t.Fatalf("create dev host failed: %v", err)
	}
	fmt.Println(res)
}

func TestSubmitDevHost(t *testing.T) {

	// Set up a connection to the server
	conn, err := grpc.Dial("localhost:8972", grpc.WithInsecure(), grpc.WithDefaultCallOptions(grpc.MaxCallRecvMsgSize(1024*1024*1024)))
	if err != nil {
		t.Fatalf("did not connect: %v", err)
	}
	defer conn.Close()
	client := pb.NewJobServiceClient(conn)
	memory := uint64(2048)
	lt := uint32(3000)
	req := &pb.CreateDevHostRequest{
		UserId:           "test",
		JobName:          "test-dev",
		Account:          "test",
		Partition:        "compute",
		Qos:              "UNLIMITED",
		CoreCount:        1,
		MemoryMb:         &memory,
		WorkingDirectory: "/data/home/test/",
		VscodeInfo: &pb.CreateDevHostRequest_VscodeInfo{
			VscodeBinPath: "/data/home/vscode/code-server-4.96.2-linux-amd64/bin/code-server",
		},
		JupyterLabInfo: &pb.CreateDevHostRequest_JupyterLabInfo{
			ProxyBasePath: "/data/home/proxy/dev-k8s-c/absolute",
		},
		Mounts:           []string{"/data/home/"},
		Image:            "ccrepo.pku.edu.cn/dockerhub/library/pytorch-ddp-test:v1",
		TimeLimitMinutes: &lt,
	}
	res, err := client.CreateDevHost(context.Background(), req)
	fmt.Println(err)
	if err != nil {
		t.Fatalf("create dev host failed: %v", err)
	}
	fmt.Println(res)
}

func TestGetDevHost(t *testing.T) {
	conn, err := grpc.Dial("localhost:8972", grpc.WithInsecure(), grpc.WithDefaultCallOptions(grpc.MaxCallRecvMsgSize(1024*1024*1024)))
	if err != nil {
		t.Fatalf("did not connect: %v", err)
	}
	defer conn.Close()
	client := pb.NewJobServiceClient(conn)
	jobType := pb.JobType_JOB_TYPE_DEV_HOST
	req := &pb.GetJobsRequest{
		Fields: []string{
			"job_id",
			"state",
			"elapsed_seconds",
			"time_limit_minutes",
			"reason",
			"partition",
			"gpus_alloc",
			"cpus_alloc",
			"mem_alloc_mb",
			"nodes_alloc",
			"gpus_req",
			"cpus_req",
			"mem_req_mb",
			"nodes_req",
		},
		JobTypes: []pb.JobType{jobType},
	}
	res, err := client.GetJobs(context.TODO(), req)
	fmt.Println(err)
	for _, job := range res.Jobs {
		fmt.Println(job)
	}
}
